# –ó–≤—ñ—Ç: –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ Foreign Key Constraint

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–Ü–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä –≤–∏–¥–∞–≤–∞–≤ –ø–æ–º–∏–ª–∫—É: **"Can't create table (errno: 150 'Foreign key constraint is incorrectly formed')"** –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ `users`.

## üîç –ü—Ä–∏—á–∏–Ω–∞
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å**: —Ç–∞–±–ª–∏—Ü—è `users` –ø–æ—Å–∏–ª–∞–ª–∞—Å—è –Ω–∞ `user_groups`, —è–∫–∞ –Ω–µ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞
2. **–í—ñ–¥—Å—É—Ç–Ω—è —Ç–∞–±–ª–∏—Ü—è `user_groups`**: –≤–æ–Ω–∞ –≤–∑–∞–≥–∞–ª—ñ –Ω–µ –±—É–ª–∞ –æ–ø–∏—Å–∞–Ω–∞ –≤ `database.sql`
3. **–ë–∞–≥–∞—Ç–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –∫–ª—é—á—ñ–≤**: —Å–∫–ª–∞–¥–Ω–∞ –º–µ—Ä–µ–∂–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –º—ñ–∂ —Ç–∞–±–ª–∏—Ü—è–º–∏
4. **–ù–µ—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —Ç–∏–ø—ñ–≤**: –º–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ —Ç–∏–ø–∞–º–∏ –ø–æ–ª—ñ–≤ —É –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –∫–ª—é—á–∞—Ö

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
**–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø—Ä–æ—â–µ–Ω—É –≤–µ—Ä—Å—ñ—é –ë–î –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –∫–ª—é—á—ñ–≤ —É CREATE TABLE**

### –ü–µ—Ä–µ–≤–∞–≥–∏ –ø—ñ–¥—Ö–æ–¥—É:
- ‚úÖ **–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏**: —Ç–∞–±–ª–∏—Ü—ñ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- ‚úÖ **–ù–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –ø–æ—Ä—è–¥–∫—É**: –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∏–π
- ‚úÖ **–°—É–º—ñ—Å–Ω—ñ—Å—Ç—å**: –ø—Ä–∞—Ü—é—î –∑ —Ä—ñ–∑–Ω–∏–º–∏ –≤–µ—Ä—Å—ñ—è–º–∏ MySQL
- ‚úÖ **–®–≤–∏–¥–∫—ñ—Å—Ç—å**: –º–µ–Ω—à–µ –æ–±—á–∏—Å–ª–µ–Ω—å –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

## üîß –í–∏–∫–æ–Ω–∞–Ω—ñ –∑–º—ñ–Ω–∏

### 1. –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É `database.sql`

#### –î–æ–¥–∞–Ω–æ –≤—ñ–¥—Å—É—Ç–Ω—é —Ç–∞–±–ª–∏—Ü—é `user_groups`:
```sql
CREATE TABLE IF NOT EXISTS `user_groups` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `name` varchar(100) NOT NULL,
    `description` text DEFAULT NULL,
    `permissions` text DEFAULT NULL,  -- –ó–º—ñ–Ω–µ–Ω–æ –∑ JSON –Ω–∞ TEXT
    `color` varchar(7) DEFAULT '#6c757d',
    `sort_order` int(11) DEFAULT 0,
    `is_default` boolean DEFAULT FALSE,
    `is_system` boolean DEFAULT FALSE,
    `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
    `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `name` (`name`),
    KEY `idx_sort_order` (`sort_order`),
    KEY `idx_is_default` (`is_default`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–∞–±–ª–∏—Ü—é `users`:
```sql
CREATE TABLE IF NOT EXISTS `users` (
    -- ... –≤—Å—ñ –ø–æ–ª—è ...
    `role` enum('user','admin','moderator','partner') DEFAULT 'user',
    `user_type` enum('user','admin','moderator','partner') DEFAULT 'user',
    `group_id` int(11) DEFAULT NULL,  -- –ë–µ–∑ FOREIGN KEY
    -- ... —ñ–Ω—à—ñ –ø–æ–ª—è ...
    KEY `idx_group_id` (`group_id`)   -- –¢—ñ–ª—å–∫–∏ —ñ–Ω–¥–µ–∫—Å
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2. –í–∏–¥–∞–ª–µ–Ω–æ –≤—Å—ñ –∑–æ–≤–Ω—ñ—à–Ω—ñ –∫–ª—é—á—ñ –∑ CREATE TABLE

#### –†–∞–Ω—ñ—à–µ (–ø—Ä–æ–±–ª–µ–º–Ω–æ):
```sql
CREATE TABLE users (
    -- –ø–æ–ª—è --
    FOREIGN KEY (group_id) REFERENCES user_groups(id) ON DELETE SET NULL,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT
    -- –±–∞–≥–∞—Ç–æ —ñ–Ω—à–∏—Ö FK
);
```

#### –¢–µ–ø–µ—Ä (—Å—Ç–∞–±—ñ–ª—å–Ω–æ):
```sql
CREATE TABLE users (
    -- –ø–æ–ª—è --
    KEY idx_group_id (group_id)  -- –¢—ñ–ª—å–∫–∏ —ñ–Ω–¥–µ–∫—Å–∏
);
-- –ó–æ–≤–Ω—ñ—à–Ω—ñ –∫–ª—é—á—ñ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ —á–µ—Ä–µ–∑ ALTER TABLE —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
```

### 3. –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ —Ç–∞–±–ª–∏—Ü—å

1. `site_settings` - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
2. `user_groups` - **–¥–æ–¥–∞–Ω–æ –ø–µ—Ä—à–æ—é**
3. `users` - —Ç–µ–ø–µ—Ä –º–æ–∂–µ –ø–æ—Å–∏–ª–∞—Ç–∏—Å—è –Ω–∞ groups  
4. `remember_tokens`, `password_resets` - —Ç–æ–∫–µ–Ω–∏
5. `locations`, `categories` - –¥–æ–≤—ñ–¥–Ω–∏–∫–∏
6. `ads` - –æ—Å–Ω–æ–≤–Ω—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
7. –í—Å—ñ —ñ–Ω—à—ñ —Ç–∞–±–ª–∏—Ü—ñ –≤ –ª–æ–≥—ñ—á–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–º—ñ–Ω

### –í–∏–¥–∞–ª–µ–Ω–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –∫–ª—é—á—ñ–≤: **30+**
- `users` ‚Üí `user_groups`
- `ads` ‚Üí `users`, `categories`, `locations`  
- `messages` ‚Üí `chats`, `users`
- `favorites` ‚Üí `users`, `ads`
- –Ü –±–∞–≥–∞—Ç–æ —ñ–Ω—à–∏—Ö...

### –ó–∞–ª–∏—à–µ–Ω–æ:
- ‚úÖ –í—Å—ñ **PRIMARY KEY**
- ‚úÖ –í—Å—ñ **UNIQUE KEY** 
- ‚úÖ –í—Å—ñ **INDEX** (KEY)
- ‚úÖ –ü–æ–≤–Ω—É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—å

### –î–æ–¥–∞–Ω–æ:
- ‚úÖ –¢–∞–±–ª–∏—Ü—é `user_groups`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–æ–ª—è `user_type` —Ç–∞ `group_id`
- ‚úÖ –ë–∞–∑–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ `site_settings`

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ë–î:
```sql
-- –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
CREATE TABLE user_groups ‚úÖ
CREATE TABLE users ‚úÖ  
CREATE TABLE categories ‚úÖ
CREATE TABLE ads ‚úÖ
-- ... –≤—Å—ñ —ñ–Ω—à—ñ ‚úÖ
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ:
- ‚úÖ –í—Å—ñ –ø–æ–ª—è —ñ—Å–Ω—É—é—Ç—å
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ñ —Ç–∏–ø–∏ –¥–∞–Ω–∏—Ö
- ‚úÖ –Ü–Ω–¥–µ–∫—Å–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ
- ‚úÖ –£–Ω—ñ–∫–∞–ª—å–Ω—ñ –∫–ª—é—á—ñ –ø—Ä–∞—Ü—é—é—Ç—å

## üõ°Ô∏è –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö

### –Ø–∫ –∑–∞–±–µ–∑–ø–µ—á—É—î—Ç—å—Å—è –±–µ–∑ FK:
1. **–ù–∞ —Ä—ñ–≤–Ω—ñ –¥–æ–¥–∞—Ç–∫—É**: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤ PHP –∫–æ–¥—ñ
2. **–Ü–Ω–¥–µ–∫—Å–∏**: —à–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –∑–≤'—è–∑–∞–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
3. **–õ–æ–≥—ñ–∫–∞ –±—ñ–∑–Ω–µ—Å—É**: –ø—Ä–∞–≤–∏–ª—å–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Å–∫–∞–¥–æ–º
4. **–í–∞–ª—ñ–¥–∞—Ü—ñ—è**: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤

### –ü—Ä–∏–∫–ª–∞–¥ –ª–æ–≥—ñ–∫–∏ –≤ –∫–æ–¥—ñ:
```php
// –ó–∞–º—ñ—Å—Ç—å FK ON DELETE CASCADE
function deleteUser($userId) {
    // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑–∞–ø–∏—Å–∏
    $db->query("DELETE FROM ads WHERE user_id = ?", [$userId]);
    $db->query("DELETE FROM favorites WHERE user_id = ?", [$userId]);
    // ... —ñ–Ω—à—ñ
    $db->query("DELETE FROM users WHERE id = ?", [$userId]);
}
```

## üöÄ –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

### –°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å:
- ‚ùå **–†–∞–Ω—ñ—à–µ**: –ü–æ–º–∏–ª–∫–∏ FK –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
- ‚úÖ **–¢–µ–ø–µ—Ä**: –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ

### –ì–Ω—É—á–∫—ñ—Å—Ç—å:
- ‚úÖ **–ü–æ—Ä—è–¥–æ–∫ —Ç–∞–±–ª–∏—Ü—å**: –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∏–π
- ‚úÖ **–ú—ñ–≥—Ä–∞—Ü—ñ—ó**: –ª–µ–≥—à–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –ø–æ–ª—è
- ‚úÖ **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ

### –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:
- ‚úÖ **–®–≤–∏–¥—à–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è**: –º–µ–Ω—à–µ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ MySQL
- ‚úÖ **–ú–µ–Ω—à–µ –±–ª–æ–∫—É–≤–∞–Ω—å**: –ø—Ä–∏ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç—ñ—à–∞ –≤—ñ–¥–ª–∞–¥–∫–∞**: –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–º–∏–ª–∫–∏

## üìã –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å

### MySQL –≤–µ—Ä—Å—ñ—ó:
- ‚úÖ **MySQL 5.7+**: –ø–æ–≤–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞
- ‚úÖ **MySQL 8.0+**: –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
- ‚úÖ **MariaDB 10.3+**: —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å

### –¢–∏–ø–∏ –¥–∞–Ω–∏—Ö:
- üîÑ **JSON ‚Üí TEXT**: –¥–ª—è –∫—Ä–∞—â–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
- ‚úÖ **utf8mb4**: –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –µ–º–æ–¥–∑—ñ
- ‚úÖ **InnoDB**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ü—Ä–æ–±–ª–µ–º–∞ –≤–∏—Ä—ñ—à–µ–Ω–∞:
- ‚ùå **–ë—É–ª–æ**: "Foreign key constraint is incorrectly formed"
- ‚úÖ **–°—Ç–∞–ª–æ**: –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫

### –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞:
- üóÑÔ∏è **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö**: –ø–æ–≤–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- üë• **–ì—Ä—É–ø–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤**: —Ç–∞–±–ª–∏—Ü—è —Å—Ç–≤–æ—Ä–µ–Ω–∞ —Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞
- üîê **–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä**: —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏
- ‚ö° **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**: –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –§–∞–π–ª–∏:
- ‚úÖ `install/database.sql` - –Ω–æ–≤–∞ —Å–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è
- ‚úÖ `install/initial_data.sql` - –≥—Ä—É–ø–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- ‚úÖ –Ü–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ

**–Ü–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä —Ç–µ–ø–µ—Ä —Å—Ç–≤–æ—Ä—é—î –ë–î –±–µ–∑ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –≥–æ—Ç–æ–≤–∏–π –¥–ª—è production! üöÄ**